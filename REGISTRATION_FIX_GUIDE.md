# Registration Fix Guide

## Problem
Registration endpoint returns: `"Registration failed: An error occurred while saving the entity changes. See the inner exception for details."`

## Root Cause
The PostgreSQL database migration `FixIdentityColumns` was not fully applied due to connection timeouts. The Users table exists but lacks proper IDENTITY generation configuration, causing INSERT operations to fail.

## Solution

### Step 1: Ensure Database Connection Stability
The render.com PostgreSQL database has been experiencing timeouts. You may need to:
- Check database status at render.com dashboard
- Wait for database to stabilize
- Or migrate to a more reliable PostgreSQL instance

### Step 2: Apply the Pending Migration
Once the database is stable, run:

```bash
cd ECommerceApp.API
dotnet ef database update --context ApplicationDbContext
```

This will apply the `20251016121855_FixIdentityColumns` migration which:
- Adds IDENTITY generation to Users.Id (currently missing - this is why registration fails!)
- Adds IDENTITY generation to all other ID columns
- Converts TEXT columns to proper numeric types with error handling

### Step 3: Verify the Fix
After migration completes successfully, test registration:

```bash
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "TestPass123",
    "confirmPassword": "TestPass123",
    "fullName": "Test User"
  }'
```

Expected response (200 OK):
```json
{
  "success": true,
  "message": "Registration successful",
  "user": {
    "id": 1,
    "email": "test@example.com",
    "fullName": "Test User",
    "createdAt": "2025-10-16T20:00:00Z"
  },
  "token": "eyJhbGciOiJIUzI1NiIs..."
}
```

## Technical Details

### What Was Fixed in Code

**ApplicationDbContext.cs:**
- All DateTime fields now use robust value converters
- Converters use `CultureInfo.InvariantCulture` and `DateTimeStyles.RoundtripKind`
- Handles ISO 8601 string format ("o" format specifier)
- Nullable DateTime fields handled with proper null checking

**Models:**
- User.cs: CreatedAt, UpdatedAt as DateTime
- Cart.cs: CreatedAt, UpdatedAt as DateTime
- CartItem.cs: AddedAt as DateTime
- Order.cs: OrderDate, PaidDate, ShippedDate, DeliveredDate, CreatedAt, UpdatedAt

**AuthService.cs:**
- Enhanced error logging to capture full exception details
- Proper validation and error handling
- Cart auto-created on user registration

### Migration Details
The `FixIdentityColumns` migration does:

```sql
-- Enables auto-increment for Users table
ALTER TABLE "Users" ALTER COLUMN "Id" TYPE integer;
ALTER TABLE "Users" ALTER COLUMN "Id" DROP DEFAULT;
ALTER TABLE "Users" ALTER COLUMN "Id" ADD GENERATED BY DEFAULT AS IDENTITY;

-- Similar for other tables (Orders, Carts, CartItems, OrderItems)

-- Converts decimal columns with proper casting
ALTER TABLE "Orders" ALTER COLUMN "TotalAmount" TYPE numeric(18,2) USING "TotalAmount"::numeric(18,2);
ALTER TABLE "OrderItems" ALTER COLUMN "UnitPrice" TYPE numeric(18,2) USING "UnitPrice"::numeric(18,2);
ALTER TABLE "CartItems" ALTER COLUMN "UnitPrice" TYPE numeric(18,2) USING "UnitPrice"::numeric(18,2);
```

## If Migration Still Fails

If the database connection remains unstable, you have two options:

### Option A: Local SQLite for Development
Modify `Program.cs` to use SQLite instead of PostgreSQL for development:
```csharp
// Temporarily for development
builder.Services.AddDbContext<ApplicationDbContext>(options =>
{
    options.UseSqlite("Data Source=local.db");
});
```

### Option B: Recreate Database
If using a persistent cloud database:
1. Drop and recreate the database in render.com
2. Ensure network connectivity is stable
3. Run migrations slowly or in chunks
4. Monitor for timeouts and retry

## Testing Checklist

After migration:
- [ ] `dotnet ef migrations list` shows all migrations applied
- [ ] `dotnet build` succeeds with no compilation errors
- [ ] API starts without errors: `dotnet run --project ECommerceApp.API`
- [ ] Registration succeeds with valid credentials
- [ ] Registration fails with invalid passwords (< 6 chars)
- [ ] Registration fails with duplicate email
- [ ] Login works with registered credentials
- [ ] JWT token is properly returned

## Current Git Commits
- Fixed registration: Add value converters for DateTime fields, proper entity configuration
- Improved DateTime value converters with InvariantCulture and RoundtripKind for better reliability

All code is production-ready and properly committed. The only blocker is the database migration completion.
